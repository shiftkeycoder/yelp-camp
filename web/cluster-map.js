mapboxgl.accessToken = token;
var campsites = {
  "features":
    [
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb85923564766",
          "title": "Redwood Creek",
          "price": 60,
          "location": "Garden Grove, California",
          "mag": 2.3,
          "time": 1507425650893,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-117.9464, 33.7746], "type": "Point" }
        
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb85923564767",
          "title": "Bullfrog Bayshore",
          "price": 194,
          "location": "Twin Falls, Idaho",
          "mag": 1.7,
          "time": 1507425289659,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-114.6972, 42.2729], "type": "Point" }
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb85923564768",
          "title": "Ancient Pond",
          "price": 167,
          "location": "Leesburg, Virginia",
          "mag": 1.6,
          "time": 1507424832518,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-77.5645, 39.1154], "type": "Point" }
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb85923564769",
          "title": "Redwood Camp",
          "price": 177,
          "location": "Vallejo, California",
          "mag": 1.42,
          "time": 1507423898710,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-122.2566, 38.1041], "type": "Point" },
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb8592356476a",
          "title": "Sky Sands",
          "price": 66,
          "location": "Quincy, Massachusetts",
          "mag": 4.2,
          "time": 1507422626990,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-71.0023, 42.2529], "type": "Point" }
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb8592356476b",
          "title": "Forest Camp",
          "price": 167,
          "location": "Battle Creek, Michigan",
          "mag": 1.6,
          "time": 1507422449194,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-85.1824, 42.3193], "type": "Point" }
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb8592356476c",
          "title": "Maple Camp",
          "price": 120,
          "location": "Hanover Park, Illinois",
          "mag": 4.6,
          "time": 1507420784440,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-88.1451, 41.9995], "type": "Point" }
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb8592356476d",
          "title": "Grizzly River",
          "price": 138,
          "location": "Sioux Falls, South Dakota",
          "mag": 2.4,
          "time": 1507419370097,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-96.7003, 43.55], "type": "Point" }
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb8592356476e",
          "title": "Petrified Creek",
          "price": 114,
          "location": "Sierra Vista, Arizona",
          "mag": 1.39,
          "time": 1507418785100,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-110.3037, 31.5545], "type": "Point" },
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb8592356476f",
          "title": "Petrified Cliffs",
          "price": 31,
          "location": "Oakland Park, Florida",
          "mag": 1.11,
          "time": 1507418426010,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-80.132, 26.1723], "type": "Point" },
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb85923564770",
          "title": "Silent Hunting Camp",
          "price": 127,
          "location": "Bedford, Texas",
          "mag": 1.5,
          "time": 1507417256497,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-97.1431, 32.844], "type": "Point" },
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb85923564771",
          "title": "Silent Hollow",
          "price": 69,
          "location": "Fort Collins, Colorado",
          "mag": 2.0,
          "time": 1507413903714,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-105.0668, 40.5509], "type": "Point" },
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb85923564772",
          "title": "Petrified Group Camp",
          "price": 47,
          "location": "Waterbury, Connecticut",
          "mag": 1.5,
          "time": 1507413670029,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-73.0515, 41.5582], "type": "Point" },
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb85923564773",
          "title": "Redwood River",
          "price": 70,
          "location": "Bismarck, North Dakota",
          "mag": 1.4,
          "time": 1507413587442,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-100.7837, 46.8083], "type": "Point" },
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb85923564774",
          "title": "Bullfrog Creek",
          "price": 144,
          "location": "Hendersonville, Tennessee",
          "mag": 1.3,
          "time": 1507413266231,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-86.62, 36.3048], "type": "Point" },
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb85923564775",
          "title": "Roaring Sands",
          "price": 110,
          "location": "Paterson, New Jersey",
          "mag": 1.8,
          "time": 1507413195076,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-74.1718, 40.9168], "type": "Point" },
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb85923564776",
          "title": "Forest Backcountry",
          "price": 186,
          "location": "San Buenaventura (Ventura), California",
          "mag": 1.9,
          "time": 1507412827617,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-119.244, 34.2578], "type": "Point" },
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb85923564777",
          "title": "Roaring Creekside",
          "price": 133,
          "location": "Alpharetta, Georgia",
          "mag": 1.2,
          "time": 1507411925999,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-84.2747, 34.071], "type": "Point" }
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb85923564778",
          "title": "Silent Flats",
          "price": 129,
          "location": "Okeechobee Florida",
          "mag": 2.0,
          "time": 1507411814209,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-80.8298, 27.2439], "type": "Point" }
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb85923564779",
          "title": "Redwood Camp",
          "price": 133,
          "location": "Westminster, Colorado",
          "mag": 4.1,
          "time": 1507411448780,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-105.0372, 39.8367], "type": "Point" }
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb8592356477a",
          "title": "Bullfrog Bay",
          "price": 118,
          "location": "Springfield, Oregon",
          "mag": 1.38,
          "time": 1507411214450,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-123.022, 44.0462], "type": "Point" }
        
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb8592356477b",
          "title": "Petrified Cliffs",
          "price": 197,
          "location": "Prescott, Arizona",
          "mag": 1.4,
          "time": 1507410206440,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-112.4695, 34.5403], "type": "Point" }
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb8592356477c",
          "title": "Grizzly Creekside",
          "price": 189,
          "location": "Richardson, Texas",
          "mag": 1.34,
          "time": 1507408122250,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-96.7297, 32.9482], "type": "Point" }
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb8592356477d",
          "title": "Sea Mule Camp",
          "price": 51,
          "location": "Farmington Hills, Michigan",
          "mag": 1.0,
          "time": 1507407938100,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-83.3772, 42.4853], "type": "Point" }
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb8592356477e",
          "title": "Ancient River",
          "price": 162,
          "location": "Midwest city, Oklahoma",
          "mag": 1.4,
          "time": 1507407100665,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-97.3967, 35.4495], "type": "Point" }
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb8592356477f",
          "title": "Elk Ghost Town",
          "price": 38,
          "location": "Brookhaven, Georgia",
          "mag": 2.55,
          "time": 1507406278360,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-84.3402, 33.8584], "type": "Point" }
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb85923564780",
          "title": "Silent Creekside",
          "price": 119,
          "location": "Madera, California",
          "mag": 1.4,
          "time": 1507405129739,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-120.0595, 36.9623], "type": "Point" }
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb85923564781",
          "title": "Redwood Ghost Town",
          "price": 49,
          "location": "Federal Way, Washington",
          "mag": 1.7,
          "time": 1507403679922,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-122.3393, 47.3135], "type": "Point" }
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb85923564782",
          "title": "Dusty Group Camp",
          "price": 170,
          "location": "Savannah, Georgia",
          "mag": 1.04,
          "time": 1507401391710,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-81.0998, 32.0835], "type": "Point" }
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb85923564783",
          "title": "Petrified Spring",
          "price": 17,
          "location": "Downey, California",
          "mag": 1.3,
          "time": 1507401212982,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-118.1326, 33.94], "type": "Point" }
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb85923564784",
          "title": "Silent Bayshore",
          "price": 86,
          "location": "Westland, Michigan",
          "mag": 1.3,
          "time": 1507399350671,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-83.4005, 42.3238], "type": "Point" }
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb85923564785",
          "title": "Redwood Cliffs",
          "price": 18,
          "location": "Rochester Hills, Michigan",
          "mag": 4.6,
          "time": 1507398878400,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-83.1499, 42.6584], "type": "Point" }
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb85923564786",
          "title": "Roaring Backcountry",
          "price": 185,
          "location": "Oceanside, California",
          "mag": 1.6,
          "time": 1507398797233,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-117.3795, 33.1959], "type": "Point" }
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb85923564787",
          "title": "Forest Ghost Town",
          "price": 74,
          "location": "Iowa city, Iowa",
          "mag": 2.64,
          "time": 1507397278960,
          "felt": 4,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-91.5299, 41.6613], "type": "Point" }
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb85923564788",
          "title": "Dusty Dispersed Camp",
          "price": 198,
          "location": "Martinez, California",
          "mag": 1.4,
          "time": 1507396778206,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-122.1341, 38.0194], "type": "Point" }
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb85923564789",
          "title": "Cascade Mule Camp",
          "price": 34,
          "location": "Newport Beach, California",
          "mag": 1.2,
          "time": 1507396542471,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-117.9294, 33.617], "type": "Point" }
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb8592356478a",
          "title": "Bullfrog Creekside",
          "price": 93,
          "location": "Eden Prairie, Minnesota",
          "mag": 4.3,
          "time": 1507395765330,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-93.4708, 44.8547], "type": "Point" }
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb8592356478b",
          "title": "Dusty Canyon",
          "price": 147,
          "location": "Cranston, Rhode Island",
          "mag": 1.91,
          "time": 1507395622730,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-71.4371, 41.781], "type": "Point" }
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb8592356478c",
          "title": "Bullfrog Ghost Town",
          "price": 194,
          "location": "Bossier city, Louisiana",
          "mag": 1.7,
          "time": 1507395602456,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-93.7321, 32.516], "type": "Point" }
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb8592356478d",
          "title": "Maple Hollow",
          "price": 69,
          "location": "Santa Clarita, California",
          "mag": 2.5,
          "time": 1507394741482,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-118.54, 34.42], "type": "Point" }
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb8592356478e",
          "title": "Diamond Creekside",
          "price": 190,
          "location": "Wilmington, North Carolina",
          "mag": 1.6,
          "time": 1507394402896,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-77.9447, 34.2257], "type": "Point" }
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb8592356478f",
          "title": "Ancient Backcountry",
          "price": 108,
          "location": "Blaine, Minnesota",
          "mag": 1.5,
          "time": 1507393418705,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-93.2349, 45.1608], "type": "Point" }
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb85923564790",
          "title": "Ancient Hollow",
          "price": 180,
          "location": "Camden, New Jersey",
          "mag": 1.6,
          "time": 1507392875390,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-75.1199, 39.9448], "type": "Point" }
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb85923564791",
          "title": "Silent Ghost Town",
          "price": 130,
          "location": "Evanston, Illinois",
          "mag": 1.3,
          "time": 1507392837463,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-87.693, 42.0447], "type": "Point" }
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb85923564792",
          "title": "Forest Bay",
          "price": 84,
          "location": "Diamond Bar, California",
          "mag": 2.3,
          "time": 1507392657193,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-117.8103, 34.0286], "type": "Point" }
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb85923564793",
          "title": "Elk Bayshore",
          "price": 205,
          "location": "Cambridge, Massachusetts",
          "mag": 4.3,
          "time": 1507392287310,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-71.1056, 42.3751], "type": "Point" }
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb85923564794",
          "title": "Redwood Backcountry",
          "price": 13,
          "location": "McKinney, Texas",
          "mag": 1.21,
          "time": 1507391530870,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-96.64, 33.22], "type": "Point" }
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb85923564795",
          "title": "Elk Horse Camp",
          "price": 105,
          "location": "Sheboygan, Wisconsin",
          "mag": 1.95,
          "time": 1507390783500,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-87.7145, 43.7508], "type": "Point" }
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6068a4f6142eb85923564796",
          "title": "Grizzly River",
          "price": 26,
          "location": "Waterloo, Iowa",
          "mag": 1.02,
          "time": 1507388708760,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-92.3369, 42.4983], "type": "Point" }
      },
      {
        "type": "Feature",
        "properties": {
          "id": "6069eb13379d9fe08a48d4dd",
          "title": "Bonnet Lake",
          "price": 109,
          "location": "Avon Park, Florida",
          "mag": 1.9,
          "time": 1507385638408,
          "felt": null,
          "tsunami": 0
        },
        "geometry": { "coordinates": [-81.5061, 27.5961], "type": "Point" }
      }
    ]
};
var map = new mapboxgl.Map({
  container: 'map',
  zoom: 0.3,
  center: [0, 20],
  style: 'mapbox://styles/mapbox/light-v10'
});

map.addControl(new mapboxgl.NavigationControl());

// filters for classifying campsites into five categories based on magnitude
var mag1 = ['<', ['get', 'mag'], 2];
var mag2 = ['all', ['>=', ['get', 'mag'], 2], ['<', ['get', 'mag'], 3]];
var mag3 = ['all', ['>=', ['get', 'mag'], 3], ['<', ['get', 'mag'], 4]];
var mag4 = ['all', ['>=', ['get', 'mag'], 4], ['<', ['get', 'mag'], 5]];
var mag5 = ['>=', ['get', 'mag'], 5];

// colors to use for the categories
var colors = ['#fed976', '#feb24c', '#fd8d3c', '#fc4e2a', '#e31a1c'];

map.on('load', function () {
  // add a clustered GeoJSON source for a sample set of campsites
  map.addSource('campsites', {
    'type': 'geojson',
    'data': campsites,
    'cluster': true,
    'clusterRadius': 80,
    'clusterProperties': {
      // keep separate counts for each magnitude category in a cluster
      'mag1': ['+', ['case', mag1, 1, 0]],
      'mag2': ['+', ['case', mag2, 1, 0]],
      'mag3': ['+', ['case', mag3, 1, 0]],
      'mag4': ['+', ['case', mag4, 1, 0]],
      'mag5': ['+', ['case', mag5, 1, 0]]
    }
  });
  // circle and symbol layers for rendering individual campsites (unclustered points)
  map.addLayer({
    'id': 'campsite_circle',
    'type': 'circle',
    'source': 'campsites',
    'filter': ['!=', 'cluster', true],
    'paint': {
      'circle-color': [
        'case',
        mag1,
        colors[0],
        mag2,
        colors[1],
        mag3,
        colors[2],
        mag4,
        colors[3],
        colors[4]
      ],
      'circle-opacity': 0.6,
      'circle-radius': 12
    }
  });
  map.addLayer({
    'id': 'campsite_label',
    'type': 'symbol',
    'source': 'campsites',
    'filter': ['!=', 'cluster', true],
    'layout': {
      'text-field': [
        'number-format',
        ['get', 'mag'],
        { 'min-fraction-digits': 1, 'max-fraction-digits': 1 }
      ],
      'text-font': ['Open Sans Semibold', 'Arial Unicode MS Bold'],
      'text-size': 10
    },
    'paint': {
      'text-color': [
        'case',
        ['<', ['get', 'mag'], 3],
        'black',
        'white'
      ]
    }
  });

  // objects for caching and keeping track of HTML marker objects (for performance)
  var markers = {};
  var markersOnScreen = {};

  function updateMarkers() {
    var newMarkers = {};
    var features = map.querySourceFeatures('campsites');

    // for every cluster on the screen, create an HTML marker for it (if we didn't yet),
    // and add it to the map if it's not there already
    for (var i = 0; i < features.length; i++) {
      var coords = features[i].geometry.coordinates;
      var props = features[i].properties;
      if (!props.cluster) continue;
      var id = props.cluster_id;

      var marker = markers[id];
      if (!marker) {
        var el = createDonutChart(props);
        marker = markers[id] = new mapboxgl.Marker({
          element: el
        }).setLngLat(coords);
      }
      newMarkers[id] = marker;

      if (!markersOnScreen[id]) marker.addTo(map);
    }
    // for every marker we've added previously, remove those that are no longer visible
    for (id in markersOnScreen) {
      if (!newMarkers[id]) markersOnScreen[id].remove();
    }
    markersOnScreen = newMarkers;
  }

  // after the GeoJSON data is loaded, update markers on the screen on every frame
  map.on('render', function () {
    if (!map.isSourceLoaded('campsites')) return;
    updateMarkers();
  });
});

// code for creating an SVG donut chart from feature properties
function createDonutChart(props) {
  var offsets = [];
  var counts = [
    props.mag1,
    props.mag2,
    props.mag3,
    props.mag4,
    props.mag5
  ];
  var total = 0;
  for (var i = 0; i < counts.length; i++) {
    offsets.push(total);
    total += counts[i];
  }
  var fontSize =
    total >= 1000 ? 22 : total >= 100 ? 20 : total >= 10 ? 18 : 16;
  var r = total >= 1000 ? 50 : total >= 100 ? 32 : total >= 10 ? 24 : 18;
  var r0 = Math.round(r * 0.6);
  var w = r * 2;

  var html =
    '<div><svg width="' +
    w +
    '" height="' +
    w +
    '" viewbox="0 0 ' +
    w +
    ' ' +
    w +
    '" text-anchor="middle" style="font: ' +
    fontSize +
    'px sans-serif; display: block">';

  for (i = 0; i < counts.length; i++) {
    html += donutSegment(
      offsets[i] / total,
      (offsets[i] + counts[i]) / total,
      r,
      r0,
      colors[i]
    );
  }
  html +=
    '<circle cx="' +
    r +
    '" cy="' +
    r +
    '" r="' +
    r0 +
    '" fill="white" /><text dominant-baseline="central" transform="translate(' +
    r +
    ', ' +
    r +
    ')">' +
    total.toLocaleString() +
    '</text></svg></div>';

  var el = document.createElement('div');
  el.innerHTML = html;
  return el.firstChild;
}

function donutSegment(start, end, r, r0, color) {
  if (end - start === 1) end -= 0.00001;
  var a0 = 2 * Math.PI * (start - 0.25);
  var a1 = 2 * Math.PI * (end - 0.25);
  var x0 = Math.cos(a0),
    y0 = Math.sin(a0);
  var x1 = Math.cos(a1),
    y1 = Math.sin(a1);
  var largeArc = end - start > 0.5 ? 1 : 0;

  return [
    '<path d="M',
    r + r0 * x0,
    r + r0 * y0,
    'L',
    r + r * x0,
    r + r * y0,
    'A',
    r,
    r,
    0,
    largeArc,
    1,
    r + r * x1,
    r + r * y1,
    'L',
    r + r0 * x1,
    r + r0 * y1,
    'A',
    r0,
    r0,
    0,
    largeArc,
    0,
    r + r0 * x0,
    r + r0 * y0,
    '" fill="' + color + '" />'
  ].join(' ');
}